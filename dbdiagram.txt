Project CityResQ360_Complete_System {
  database_type: "Multi-Database Architecture"
  Note: '''
    Complete database schema for CityResQ360 Platform
    11 Microservices with separate databases
    OLP 2025 - Smart City Application
  '''
}

/* ============================================================================
   SERVICE 1: CORE API (Laravel) - MySQL/PostgreSQL
   Port: 8000
   Purpose: BFF Layer, User Management, Master Data
   ============================================================================ */

Table core_api.quan_tri_viens {
  id bigint [pk, increment]
  ten_quan_tri varchar(120)
  email varchar(190) [unique]
  mat_khau varchar(255)
  vai_tro tinyint [default: 1, note: '0:superadmin, 1:data_admin, 2:agency_admin']
  anh_dai_dien varchar(255)
  trang_thai tinyint [default: 1, note: '1:active, 0:locked']
  lan_dang_nhap_cuoi timestamp
  created_at timestamp
  updated_at timestamp
  deleted_at timestamp
  
  indexes {
    (email)
    (vai_tro, trang_thai)
  }
  
  Note: 'Quản trị viên hệ thống'
}

Table core_api.nguoi_dungs {
  id bigint [pk, increment]
  ho_ten varchar(120)
  email varchar(190) [unique]
  mat_khau varchar(255)
  so_dien_thoai varchar(20)
  vai_tro tinyint [default: 0, note: '0:citizen, 1:officer']
  anh_dai_dien varchar(255)
  trang_thai tinyint [default: 1, note: '1:active, 0:banned']
  diem_thanh_pho int [default: 0, note: 'CityPoint token thưởng']
  xac_thuc_cong_dan boolean [default: false, note: 'KYC verified']
  diem_uy_tin int [default: 0]
  tong_so_phan_anh int [default: 0]
  so_phan_anh_chinh_xac int [default: 0]
  ty_le_chinh_xac float [default: 0, note: '%']
  cap_huy_hieu tinyint [default: 0, note: '0:bronze, 1:silver, 2:gold, 3:platinum']
  push_token varchar(255) [note: 'FCM token']
  tuy_chon_thong_bao json
  created_at timestamp
  updated_at timestamp
  deleted_at timestamp
  
  indexes {
    (email)
    (so_dien_thoai)
    (vai_tro, trang_thai)
    (diem_uy_tin)
  }
  
  Note: 'Người dùng/Công dân'
}

Table core_api.co_quan_xu_lys {
  id bigint [pk, increment]
  ten_co_quan varchar(150)
  email_lien_he varchar(150)
  so_dien_thoai varchar(30)
  dia_chi varchar(255)
  cap_do tinyint [default: 0, note: '0:ward, 1:district, 2:city']
  mo_ta text
  trang_thai tinyint [default: 1, note: '1:active, 0:inactive']
  created_at timestamp
  updated_at timestamp
  deleted_at timestamp
  
  indexes {
    (cap_do, trang_thai)
  }
  
  Note: 'Cơ quan xử lý phản ánh'
}

Table core_api.phan_anhs {
  id bigint [pk, increment]
  nguoi_dung_id bigint [note: 'FK to nguoi_dungs']
  tieu_de varchar(255)
  mo_ta text
  danh_muc tinyint [note: '0:traffic, 1:environment, 2:fire, 3:waste, 4:flood, 5:other']
  trang_thai tinyint [default: 0, note: '0:pending, 1:verified, 2:in_progress, 3:resolved, 4:rejected']
  uu_tien tinyint [default: 1, note: '0:low, 1:medium, 2:high, 3:urgent']
  vi_do decimal(10,7)
  kinh_do decimal(10,7)
  dia_chi varchar(255)
  nhan_ai varchar(100) [note: 'AI classification result']
  do_tin_cay float [note: 'AI confidence 0-1']
  co_quan_phu_trach_id bigint [note: 'FK to co_quan_xu_lys']
  la_cong_khai boolean [default: true]
  luot_ung_ho int [default: 0]
  luot_khong_ung_ho int [default: 0]
  luot_xem int [default: 0]
  han_phan_hoi timestamp
  thoi_gian_phan_hoi_thuc_te int [note: 'minutes']
  thoi_gian_giai_quyet int [note: 'hours']
  danh_gia_hai_long tinyint [note: '1-5 stars']
  la_trung_lap boolean [default: false]
  trung_lap_voi_id bigint [note: 'FK to self']
  the_tags json
  du_lieu_mo_rong json
  created_at timestamp
  updated_at timestamp
  deleted_at timestamp
  
  indexes {
    (nguoi_dung_id, created_at)
    (trang_thai, created_at)
    (danh_muc, trang_thai)
    (co_quan_phu_trach_id, trang_thai)
    (uu_tien, trang_thai)
  }
  
  Note: 'Phản ánh từ người dân - Master table'
}

Table core_api.binh_luan_phan_anhs {
  id bigint [pk, increment]
  phan_anh_id bigint [ref: > core_api.phan_anhs.id]
  nguoi_dung_id bigint [ref: > core_api.nguoi_dungs.id]
  noi_dung text
  la_chinh_thuc boolean [default: false, note: 'từ cơ quan']
  binh_luan_cha_id bigint [ref: > core_api.binh_luan_phan_anhs.id]
  created_at timestamp
  updated_at timestamp
  deleted_at timestamp
  
  indexes {
    (phan_anh_id, created_at)
    (nguoi_dung_id)
  }
  
  Note: 'Bình luận vào phản ánh'
}

Table core_api.binh_chon_phan_anhs {
  id bigint [pk, increment]
  phan_anh_id bigint [ref: > core_api.phan_anhs.id]
  nguoi_dung_id bigint [ref: > core_api.nguoi_dungs.id]
  loai_binh_chon tinyint [note: '1:upvote, 0:downvote']
  created_at timestamp
  updated_at timestamp
  
  indexes {
    (phan_anh_id, nguoi_dung_id) [unique]
    (phan_anh_id, loai_binh_chon)
  }
  
  Note: 'Vote phản ánh'
}

Table core_api.nhat_ky_he_thongs {
  id bigint [pk, increment]
  nguoi_dung_id bigint
  hanh_dong varchar(100)
  loai_doi_tuong varchar(100)
  id_doi_tuong bigint
  du_lieu_meta json
  dia_chi_ip varchar(45)
  user_agent text
  created_at timestamp
  
  indexes {
    (nguoi_dung_id, created_at)
    (loai_doi_tuong, id_doi_tuong)
    (hanh_dong, created_at)
  }
  
  Note: 'Audit logs'
}

Table core_api.cau_hinh_he_thongs {
  id bigint [pk, increment]
  khoa_cau_hinh varchar(100) [unique]
  gia_tri text
  loai_du_lieu tinyint [note: '0:string, 1:integer, 2:float, 3:boolean, 4:json']
  mo_ta text
  nhom varchar(50)
  created_at timestamp
  updated_at timestamp
  
  indexes {
    (khoa_cau_hinh)
    (nhom)
  }
  
  Note: 'System configuration'
}

Table core_api.phien_ban_apis {
  id bigint [pk, increment]
  phien_ban varchar(20) [unique]
  mo_ta text
  ngay_phat_hanh date
  ngay_het_han date
  trang_thai tinyint [note: '0:deprecated, 1:active, 2:beta']
  ghi_chu_thay_doi text
  created_at timestamp
  
  indexes {
    (phien_ban)
    (trang_thai)
  }
  
  Note: 'API versioning'
}

Ref: core_api.phan_anhs.nguoi_dung_id > core_api.nguoi_dungs.id
Ref: core_api.phan_anhs.co_quan_phu_trach_id > core_api.co_quan_xu_lys.id
Ref: core_api.phan_anhs.trung_lap_voi_id > core_api.phan_anhs.id

/* ============================================================================
   SERVICE 2: INCIDENT SERVICE - PostgreSQL
   Port: 8001
   Purpose: Incident Management, Alerting, Rules
   ============================================================================ */

Table incident_service.su_cos {
  id bigint [pk, increment]
  phan_anh_id bigint [note: 'Reference to core_api.phan_anhs.id (no FK)']
  nguoi_bao_cao_id bigint [note: 'Reference to core_api.nguoi_dungs.id']
  loai_su_co varchar(100)
  muc_do_nghiem_trong tinyint [note: '0:low, 1:medium, 2:high, 3:critical']
  trang_thai tinyint [default: 0, note: '0:new, 1:monitoring, 2:alerted, 3:closed']
  co_quan_phu_trach_id bigint [note: 'Reference to core_api.co_quan_xu_lys.id']
  mo_ta text
  thoi_gian_xu_ly_du_kien timestamp
  thoi_gian_xu_ly_thuc_te timestamp
  ghi_chu_xu_ly text
  created_at timestamp
  updated_at timestamp
  deleted_at timestamp
  
  indexes {
    (phan_anh_id)
    (muc_do_nghiem_trong, trang_thai)
    (co_quan_phu_trach_id, trang_thai)
    (created_at)
  }
  
  Note: 'Sự cố được tạo từ phản ánh'
}

Table incident_service.canh_baos {
  id bigint [pk, increment]
  su_co_id bigint [ref: > incident_service.su_cos.id]
  ma_quy_tac varchar(50)
  loai_canh_bao tinyint [note: '0:sensor, 1:vision, 2:nlp, 3:manual']
  thong_diep text
  thoi_gian_kich_hoat timestamp
  thoi_gian_giai_quyet timestamp
  trang_thai tinyint [default: 0, note: '0:active, 1:resolved']
  muc_do_uu_tien tinyint [note: '0:info, 1:warning, 2:critical']
  created_at timestamp
  updated_at timestamp
  
  indexes {
    (su_co_id, thoi_gian_kich_hoat)
    (trang_thai, thoi_gian_kich_hoat)
    (loai_canh_bao)
  }
  
  Note: 'Cảnh báo từ sự cố'
}

Table incident_service.lich_su_trang_thai_su_cos {
  id bigint [pk, increment]
  su_co_id bigint [ref: > incident_service.su_cos.id]
  trang_thai_cu tinyint
  trang_thai_moi tinyint
  nguoi_thay_doi_id bigint [note: 'Reference to core_api.nguoi_dungs.id']
  ghi_chu text
  created_at timestamp
  
  indexes {
    (su_co_id, created_at)
  }
  
  Note: 'Lịch sử thay đổi trạng thái sự cố'
}

Table incident_service.quy_tac_canh_baos {
  id bigint [pk, increment]
  ten_quy_tac varchar(150)
  ma_quy_tac varchar(50) [unique]
  mo_ta text
  dieu_kien json [note: 'Rule conditions']
  hanh_dong json [note: 'Actions to take']
  loai_quy_tac tinyint [note: '0:sensor, 1:time_based, 2:threshold, 3:pattern']
  muc_do_uu_tien tinyint
  trang_thai tinyint [default: 1, note: '1:active, 0:inactive']
  so_lan_kich_hoat int [default: 0]
  lan_kich_hoat_cuoi timestamp
  created_at timestamp
  updated_at timestamp
  deleted_at timestamp
  
  indexes {
    (ma_quy_tac)
    (loai_quy_tac, trang_thai)
  }
  
  Note: 'Quy tắc cảnh báo tự động'
}

/* ============================================================================
   SERVICE 3: IOT/SENSOR SERVICE - TimescaleDB (PostgreSQL + Extension)
   Port: 8002
   Purpose: IoT Sensors, Time-series Observations
   ============================================================================ */

Table iot_service.cam_biens {
  id bigint [pk, increment]
  ma_cam_bien varchar(100) [unique]
  ten_cam_bien varchar(150)
  loai_cam_bien varchar(100)
  vi_do decimal(10,7)
  kinh_do decimal(10,7)
  gia_tri_cuoi float
  don_vi varchar(50)
  nha_san_xuat varchar(100)
  mo_hinh varchar(100)
  so_seri varchar(150)
  ngay_lap_dat date
  ngay_bao_tri_cuoi date
  muc_pin float [note: '%']
  cuong_do_tin_hieu int [note: 'dBm']
  trang_thai_truc_tuyen boolean [default: true]
  trang_thai_hieu_chuan tinyint [note: '0:calibrated, 1:needs_calibration, 2:faulty']
  du_lieu_mo_rong jsonb [note: 'NGSI-LD metadata']
  created_at timestamptz
  updated_at timestamptz
  deleted_at timestamptz
  
  indexes {
    (ma_cam_bien)
    (loai_cam_bien, trang_thai_truc_tuyen)
    (trang_thai_hieu_chuan)
  }
  
  Note: 'Cảm biến IoT'
}

Table iot_service.quan_sats {
  time timestamptz [pk, note: 'TimescaleDB hypertable - time column']
  cam_bien_id bigint [note: 'Reference to cam_biens.id']
  thuoc_tinh_quan_sat varchar(100)
  gia_tri double_precision
  don_vi varchar(50)
  chat_luong_du_lieu smallint [note: '0:good, 1:fair, 2:poor']
  ghi_chu text
  created_at timestamptz [default: `now()`]
  
  indexes {
    (cam_bien_id, time)
    (thuoc_tinh_quan_sat, time)
  }
  
  Note: '''
    Quan sát từ cảm biến - Time-series data
    Converted to TimescaleDB hypertable for optimization
  '''
}

Table iot_service.cam_bien_muc_nuocs {
  id bigint [pk, increment]
  cam_bien_id bigint [note: 'Reference to cam_biens.id']
  khu_vuc_ngap_lut_id bigint [note: 'Reference to floodeye_service.khu_vuc_ngap_luts.id']
  muc_nuoc_hien_tai float [note: 'cm']
  nguong_canh_bao float [note: 'cm']
  nguong_nguy_hiem float [note: 'cm']
  thoi_gian_do_cuoi timestamptz
  trang_thai_hoat_dong smallint [note: '0:normal, 1:warning, 2:error']
  created_at timestamptz
  updated_at timestamptz
  
  indexes {
    (cam_bien_id)
    (khu_vuc_ngap_lut_id, thoi_gian_do_cuoi)
  }
  
  Note: 'Cảm biến mực nước cho FloodEye'
}

/* ============================================================================
   SERVICE 4: MEDIA SERVICE - MongoDB
   Port: 8004
   Purpose: File Upload, Storage, Metadata
   Note: This is a NoSQL schema representation
   ============================================================================ */

Table media_service.media_files {
  id ObjectId [pk, note: 'MongoDB ObjectId']
  phan_anh_id bigint [note: 'Reference to core_api.phan_anhs.id']
  nguoi_tai_len_id bigint [note: 'Reference to core_api.nguoi_dungs.id']
  duong_dan_tep varchar(255) [note: 'S3/MinIO path']
  loai_tap_tin varchar(100)
  kich_thuoc bigint [note: 'bytes']
  thoi_gian_tai_len timestamp
  la_anh_chinh boolean [default: false]
  thu_tu_hien_thi int [default: 0]
  thumbnail_url varchar(255)
  processing_status varchar(50) [note: 'pending, processing, completed, failed']
  metadata json [note: 'width, height, duration, format, exif']
  ai_analysis json [note: 'labels, confidence, analyzed_at']
  created_at timestamp
  updated_at timestamp
  
  indexes {
    (phan_anh_id, thu_tu_hien_thi)
    (nguoi_tai_len_id)
    (processing_status)
  }
  
  Note: '''
    File metadata (MongoDB)
    Actual files stored in MinIO/S3
  '''
}

/* ============================================================================
   SERVICE 5: WALLET SERVICE - PostgreSQL
   Port: 8005
   Purpose: CityPoint Wallet, Transactions, Rewards
   ============================================================================ */

Table wallet_service.vi_dien_tus {
  id bigint [pk, increment]
  nguoi_dung_id bigint [unique, note: 'Reference to core_api.nguoi_dungs.id']
  so_du_hien_tai decimal(15,2) [default: 0]
  so_du_tam_giu decimal(15,2) [default: 0]
  tong_nhan decimal(15,2) [default: 0]
  tong_chi decimal(15,2) [default: 0]
  created_at timestamptz
  updated_at timestamptz
  
  indexes {
    (nguoi_dung_id)
  }
  
  Note: 'Ví điện tử CityPoint'
}

Table wallet_service.giao_dich_vi_dien_tus {
  id bigint [pk, increment]
  vi_id bigint [ref: > wallet_service.vi_dien_tus.id]
  nguoi_dung_id bigint [note: 'Reference to core_api.nguoi_dungs.id']
  so_tien decimal(10,2)
  loai_giao_dich smallint [note: '0:reward, 1:spend, 2:admin_adjust']
  mo_ta varchar(255)
  ma_giao_dich_hash varchar(100)
  phan_anh_lien_quan_id bigint [note: 'Reference to core_api.phan_anhs.id']
  trang_thai smallint [default: 1, note: '0:pending, 1:completed, 2:failed']
  so_du_truoc decimal(15,2)
  so_du_sau decimal(15,2)
  metadata jsonb
  created_at timestamptz
  updated_at timestamptz
  
  indexes {
    (vi_id, created_at)
    (nguoi_dung_id, created_at)
    (loai_giao_dich, created_at)
  }
  
  Note: 'Giao dịch CityPoint'
}

Table wallet_service.lich_su_city_points {
  id bigint [pk, increment]
  nguoi_dung_id bigint [note: 'Reference to core_api.nguoi_dungs.id']
  hanh_dong varchar(100) [note: 'report_verified, helpful_comment, etc.']
  diem_thay_doi int
  ly_do text
  created_at timestamptz
  
  indexes {
    (nguoi_dung_id, created_at)
  }
  
  Note: 'Lịch sử thay đổi điểm'
}

/* ============================================================================
   SERVICE 6: FLOODEYE SERVICE - PostgreSQL + PostGIS
   Port: 8008
   Purpose: Flood Monitoring, Geospatial Data, GTFS
   ============================================================================ */

Table floodeye_service.khu_vuc_ngap_luts {
  id bigint [pk, increment]
  ten_khu_vuc varchar(150)
  ma_khu_vuc varchar(50) [unique]
  vung_dia_ly text [note: 'PostGIS geography(polygon, 4326)']
  muc_do_rui_ro smallint [note: '0:low, 1:medium, 2:high, 3:critical']
  dan_so_anh_huong int
  mo_ta text
  ngay_cap_nhat_rui_ro date
  trang_thai smallint [default: 0, note: '0:normal, 1:warning, 2:danger']
  metadata jsonb
  created_at timestamptz
  updated_at timestamptz
  deleted_at timestamptz
  
  indexes {
    (ma_khu_vuc)
    (muc_do_rui_ro, trang_thai)
  }
  
  Note: 'Khu vực ngập lụt'
}

Table floodeye_service.canh_bao_ngap_luts {
  id bigint [pk, increment]
  khu_vuc_id bigint [ref: > floodeye_service.khu_vuc_ngap_luts.id]
  muc_nuoc float [note: 'cm']
  nguong_vuot_qua boolean [default: false]
  thong_diep_canh_bao text
  thoi_gian_kich_hoat timestamptz
  thoi_gian_giai_quyet timestamptz
  trang_thai smallint [default: 0, note: '0:active, 1:monitoring, 2:resolved']
  muc_do_nghiem_trong smallint [note: '0:info, 1:warning, 2:danger, 3:critical']
  du_lieu_cam_bien jsonb
  vi_tri_anh_huong text [note: 'PostGIS geography(polygon, 4326)']
  created_at timestamptz
  updated_at timestamptz
  
  indexes {
    (khu_vuc_id, thoi_gian_kich_hoat)
    (trang_thai, muc_do_nghiem_trong)
  }
  
  Note: 'Cảnh báo ngập lụt'
}

Table floodeye_service.tuyen_giao_thongs {
  id bigint [pk, increment]
  ma_tuyen varchar(50) [unique]
  ten_tuyen varchar(150)
  loai_phuong_tien smallint [note: '0:bus, 1:metro, 2:train, 3:ferry']
  tuyen_duong text [note: 'PostGIS geography(linestring, 4326)']
  mau_sac_tuyen varchar(20)
  trang_thai_hoat_dong smallint [default: 1, note: '1:active, 0:inactive']
  created_at timestamptz
  updated_at timestamptz
  
  indexes {
    (ma_tuyen)
    (loai_phuong_tien, trang_thai_hoat_dong)
  }
  
  Note: 'Tuyến giao thông công cộng (GTFS)'
}

Table floodeye_service.tram_dungs {
  id bigint [pk, increment]
  ma_tram varchar(50) [unique]
  ten_tram varchar(150)
  vi_do decimal(10,7)
  kinh_do decimal(10,7)
  dia_chi varchar(255)
  loai_tram smallint [note: '0:bus_stop, 1:metro_station, 2:train_station']
  tien_nghi jsonb [note: 'Facilities available']
  created_at timestamptz
  updated_at timestamptz
  
  indexes {
    (ma_tram)
    (loai_tram)
  }
  
  Note: 'Trạm dừng'
}

Table floodeye_service.chi_tiet_tuyen_trams {
  id bigint [pk, increment]
  tuyen_id bigint [ref: > floodeye_service.tuyen_giao_thongs.id]
  tram_id bigint [ref: > floodeye_service.tram_dungs.id]
  thu_tu_dung int
  khoang_cach_tu_tram_truoc float [note: 'km']
  thoi_gian_du_kien int [note: 'minutes']
  created_at timestamptz
  
  indexes {
    (tuyen_id, thu_tu_dung)
    (tram_id)
  }
  
  Note: 'Chi tiết tuyến - trạm'
}

/* ============================================================================
   SERVICE 7: AI/ML SERVICE - PostgreSQL + pgvector
   Port: 8003
   Purpose: ML Training Data, Model Metrics, Vector Search
   ============================================================================ */

Table ai_service.du_lieu_huan_luyen_ais {
  id bigint [pk, increment]
  phan_anh_id bigint [note: 'Reference to core_api.phan_anhs.id']
  loai_mo_hinh smallint [note: '0:nlp, 1:vision, 2:hybrid']
  van_ban_dau_vao text
  duong_dan_anh_dau_vao varchar(255)
  nhan_du_doan varchar(100)
  nhan_thuc_te varchar(100) [note: 'Human verified']
  do_tin_cay float
  da_xac_minh boolean [default: false]
  nguoi_xac_minh_id bigint [note: 'Reference to core_api.quan_tri_viens.id']
  thoi_gian_xac_minh timestamptz
  ghi_chu text
  text_embedding vector(768) [note: 'PhoBERT embeddings']
  image_embedding vector(512) [note: 'ResNet/CLIP embeddings']
  created_at timestamptz
  updated_at timestamptz
  
  indexes {
    (loai_mo_hinh, da_xac_minh)
    (nhan_du_doan, nhan_thuc_te)
    (phan_anh_id)
  }
  
  Note: '''
    Dữ liệu huấn luyện AI
    Using pgvector for similarity search
  '''
}

Table ai_service.hieu_suat_mo_hinhs {
  id bigint [pk, increment]
  ten_mo_hinh varchar(100)
  phien_ban varchar(50)
  do_chinh_xac float [note: 'accuracy']
  do_chinh_xac_du_doan float [note: 'precision']
  ty_le_hoi_tuong float [note: 'recall']
  diem_f1 float [note: 'f1_score']
  ma_tran_nham_lan jsonb [note: 'Confusion matrix']
  so_mau_kiem_tra int
  thoi_gian_danh_gia timestamptz
  ghi_chu text
  created_at timestamptz
  
  indexes {
    (ten_mo_hinh, phien_ban)
    (thoi_gian_danh_gia)
  }
  
  Note: 'Hiệu suất mô hình AI'
}

/* ============================================================================
   SERVICE 8: CONTEXT BROKER - MongoDB
   Port: 1026
   Purpose: NGSI-LD Entities, Linked Data, Semantic Web
   Note: This is a NoSQL schema representation
   ============================================================================ */

Table context_broker.ngsi_entities {
  id ObjectId [pk, note: 'MongoDB ObjectId']
  entityId varchar(255) [unique, note: 'urn:ngsi-ld:Report:12345']
  type varchar(100) [note: 'Report, Sensor, Agency, Event']
  context_url varchar(255) [note: '@context URL']
  properties json [note: 'NGSI-LD properties']
  relationships json [note: 'NGSI-LD relationships']
  location json [note: 'GeoJSON location']
  observedAt timestamp
  createdAt timestamp
  modifiedAt timestamp
  
  indexes {
    (entityId)
    (type, createdAt)
  }
  
  Note: '''
    NGSI-LD entities
    Compliant with ETSI NGSI-LD specification
  '''
}

Table context_broker.entity_relationships {
  id ObjectId [pk]
  source_entity varchar(255) [note: 'Source entity ID']
  target_entity varchar(255) [note: 'Target entity ID']
  relationship_type varchar(100) [note: 'hasLocation, managedBy, observedBy']
  metadata json
  created_at timestamp
  
  indexes {
    (source_entity, relationship_type)
    (target_entity)
  }
  
  Note: 'Entity relationships'
}

Table context_broker.rdf_triples {
  id ObjectId [pk]
  subject varchar(255) [note: 'Subject URI']
  predicate varchar(255) [note: 'Predicate URI - sosa:observes']
  object varchar(255) [note: 'Object value or URI']
  object_type varchar(50) [note: 'uri, literal, blank_node']
  datatype varchar(100)
  language varchar(10) [note: 'vi, en']
  graph_uri varchar(255)
  created_at timestamp
  
  indexes {
    (subject, predicate)
    (predicate, object)
    (graph_uri)
  }
  
  Note: 'RDF triples for semantic web'
}

/* ============================================================================
   SERVICE 9: NOTIFICATION SERVICE - PostgreSQL + Redis
   Port: 8006
   Purpose: Push Notifications, Email, SMS, WebSocket
   ============================================================================ */

Table notification_service.thong_baos {
  id bigint [pk, increment]
  nguoi_dung_id bigint [note: 'Reference to core_api.nguoi_dungs.id']
  canh_bao_id bigint [note: 'Reference to incident_service.canh_baos.id']
  tieu_de varchar(150)
  noi_dung text
  kenh_gui smallint [note: '0:app, 1:email, 2:sms, 3:websocket']
  thoi_gian_gui timestamptz
  thoi_gian_doc timestamptz
  la_da_doc boolean [default: false]
  delivery_status smallint [note: '0:pending, 1:sent, 2:failed']
  retry_count int [default: 0]
  created_at timestamptz
  updated_at timestamptz
  
  indexes {
    (nguoi_dung_id, thoi_gian_gui)
    (nguoi_dung_id, la_da_doc)
    (delivery_status)
  }
  
  Note: '''
    Thông báo (PostgreSQL - History)
    Redis used for queue & real-time delivery
  '''
}

/* ============================================================================
   SERVICE 10: ANALYTICS SERVICE - ClickHouse
   Port: 8009
   Purpose: Dashboard Metrics, Agency Performance, OLAP
   Note: ClickHouse syntax differs from standard SQL
   ============================================================================ */

Table analytics_service.chi_so_dashboards {
  ngay Date [note: 'ClickHouse Date type']
  gio DateTime [note: 'ClickHouse DateTime type']
  khoa_chi_so varchar(100)
  gia_tri_chi_so decimal(15,2)
  don_vi varchar(50)
  danh_muc smallint [note: '0:reports, 1:incidents, 2:response_time, 3:city_points, 4:agencies']
  chu_ky smallint [note: '0:hourly, 1:daily, 2:weekly, 3:monthly']
  du_lieu_mo_rong varchar(1000) [note: 'JSON as String in ClickHouse']
  created_at DateTime [default: `now()`]
  
  indexes {
    (ngay, gio, khoa_chi_so)
    (danh_muc, chu_ky)
  }
  
  Note: '''
    Dashboard metrics (ClickHouse)
    PARTITION BY toYYYYMM(ngay)
    ORDER BY (ngay, gio, khoa_chi_so)
  '''
}

Table analytics_service.hieu_suat_co_quans {
  ngay Date
  co_quan_id bigint [note: 'Reference to core_api.co_quan_xu_lys.id']
  tong_so_duoc_giao int
  tong_so_da_giai_quyet int
  thoi_gian_phan_hoi_trung_binh int [note: 'minutes']
  thoi_gian_giai_quyet_trung_binh int [note: 'hours']
  diem_hai_long float [note: '1-5']
  ty_le_giai_quyet_dung_han float [note: '%']
  created_at DateTime [default: `now()`]
  
  indexes {
    (ngay, co_quan_id)
    (diem_hai_long)
  }
  
  Note: '''
    Agency performance (ClickHouse)
    PARTITION BY toYYYYMM(ngay)
    ORDER BY (ngay, co_quan_id)
  '''
}

/* ============================================================================
   SERVICE 11: OPEN DATA SERVICE - PostgreSQL
   Port: 8007
   Purpose: OpenStreetMap, OpenWeather, GTFS Integration
   ============================================================================ */

Table opendata_service.nguon_du_lieu_mos {
  id bigint [pk, increment]
  ten_nguon varchar(150) [note: 'OpenStreetMap, OpenWeather, GTFS']
  loai_nguon smallint [note: '0:osm, 1:weather, 2:transport, 3:other']
  api_endpoint varchar(255)
  api_key varchar(255)
  thoi_gian_dong_bo_cuoi timestamptz
  trang_thai_dong_bo smallint [note: '0:success, 1:failed, 2:pending']
  so_ban_ghi_dong_bo int
  nhat_ky_loi text
  tan_suat_dong_bo int [note: 'minutes']
  created_at timestamptz
  updated_at timestamptz
  
  indexes {
    (loai_nguon, trang_thai_dong_bo)
    (thoi_gian_dong_bo_cuoi)
  }
  
  Note: 'Nguồn dữ liệu mở'
}

Table opendata_service.bo_nho_dem_du_lieus {
  id bigint [pk, increment]
  nguon_id bigint [ref: > opendata_service.nguon_du_lieu_mos.id]
  khoa_cache varchar(255) [unique]
  du_lieu jsonb
  thoi_gian_het_han timestamptz
  so_lan_truy_cap int [default: 0]
  created_at timestamptz
  updated_at timestamptz
  
  indexes {
    (khoa_cache, thoi_gian_het_han)
    (nguon_id, thoi_gian_het_han)
  }
  
  Note: 'Cache dữ liệu từ API ngoài'
}

Table opendata_service.du_lieu_thoi_tiets {
  id bigint [pk, increment]
  vi_do decimal(10,7)
  kinh_do decimal(10,7)
  nhiet_do float [note: 'Celsius']
  do_am int [note: '%']
  luong_mua float [note: 'mm']
  toc_do_gio float [note: 'km/h']
  huong_gio varchar(20)
  mo_ta_thoi_tiet varchar(100)
  chi_so_uv int
  tam_nhin float [note: 'km']
  ap_suat float [note: 'hPa']
  thoi_gian_du_bao timestamptz
  nguon_du_lieu varchar(100) [note: 'OpenWeather']
  created_at timestamptz
  
  indexes {
    (vi_do, kinh_do, thoi_gian_du_bao)
    (thoi_gian_du_bao)
  }
  
  Note: 'Dữ liệu thời tiết từ OpenWeather'
}

/* ============================================================================
   CROSS-SERVICE RELATIONSHIPS (Logical References Only)
   Note: These are NOT actual foreign keys in implementation
   ============================================================================ */

// Note: Cross-database references are handled at application level
// via Service-to-Service API calls or Event-Driven Architecture

Note cross_references {
  '''
  === CROSS-SERVICE REFERENCES ===
  
  These relationships exist logically but are NOT enforced by database FKs
  because tables are in different databases/services.
  
  Communication via:
  - REST API calls
  - gRPC calls
  - Kafka/RabbitMQ events
  
  Example flows:
  1. core_api.phan_anhs.id → incident_service.su_cos.phan_anh_id (via event)
  2. core_api.nguoi_dungs.id → wallet_service.vi_dien_tus.nguoi_dung_id (via API)
  3. iot_service.cam_biens.id → floodeye_service.khu_vuc_ngap_luts (via API)
  
  '''
}